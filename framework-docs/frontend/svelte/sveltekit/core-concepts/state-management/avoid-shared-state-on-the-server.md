**Avoid shared state on the server (서버에서 공유 상태 사용 금지)**

브라우저는 상태를 유지해. 사용자가 앱이랑 상호작용하면서 생기는 데이터들이 메모리에 차곡차곡 쌓이지. 반면에 서버는 기본적으로 상태가 없어. 요청이 들어오면 그 요청 내용만 보고 응답을 딱 만들어낼 뿐, 이전 요청을 기억하거나 하지 않아.

...라고 말은 하지만, 현실적으로 서버는 오랫동안 켜져 있고 여러 사용자가 동시에 접속해서 쓴단 말이지. 그래서 여러 사용자가 같이 쓰는 변수에 데이터를 저장하면 절대 안 돼. 예를 들어 이런 코드가 있다고 쳐보자:

```typescript
// +page.server.ts (또는 .js)

import type { PageServerLoad, Actions } from './$types';

let user; // 이런 식으로 서버 전역 변수 쓰면 큰일남!

export const load: PageServerLoad = () => {
	// 이 user는 모든 사용자가 공유하게 됨
	return { user };
};

export const actions = {
	default: async ({ request }) => {
		const data = await request.formData();

		// 절대로 이렇게 하지 마세요!
		user = {
			name: data.get('name'),
			embarrassingSecret: data.get('secret') // 민감 정보가...
		};
	}
} satisfies Actions;
```

저 `user` 변수는 이 서버에 접속하는 모든 사람이 공유하게 돼. 만약 앨리스가 자기 비밀을 제출하고, 그 뒤에 밥이 페이지에 접속하면, 밥은 앨리스의 비밀을 알게 되는 거야. "앨리스 비밀번호 1234래~ (소곤소곤)" 이런 대참사가 벌어지는 거지. 게다가 앨리스가 나중에 다시 사이트에 들어왔을 때 서버가 재시작이라도 됐다면? 앨리스 데이터는 그냥 허공으로 사라지는 거야.

이런 방식 대신에, 쿠키를 사용해서 사용자를 인증하고 데이터는 데이터베이스에 안전하게 저장해야 해.

---

**얘 뭐 하는 애냐?**
서버 사이드 코드, 특히 여러 요청을 동시에 처리할 수 있는 환경(Node.js 같은 거)에서 "전역 변수나 모듈 레벨 변수에 사용자별 데이터를 저장하지 마라!"는 강력한 경고야. 서버는 공용 공간인데, 거기에 개인 물건(데이터)을 아무렇게나 던져두면 다른 사람이 보거나 가져갈 수 있다는 거지. "찜질방 공용 락커에 귀중품 넣어두고 '안전하겠지?' 하는 격."

**왜 쓰는데? (왜 피해야 하는데?)**
1.  **데이터 유출/오염 (보안 문제):** 이게 제일 심각해. 사용자 A의 정보가 사용자 B에게 보이거나, B의 행동으로 A의 데이터가 바뀌는 말도 안 되는 상황이 발생해. 개인정보, 결제 정보 같은 민감한 데이터가 섞이면 그냥 서비스 문 닫아야 할 수도 있어. "옆집 택배가 우리 집에 온 것도 황당한데, 이건 옆집 신용카드 명세서가 우리 집에 온 꼴."
2.  **데이터 불일치/유실:** 서버는 언제든지 재시작될 수 있고, 여러 인스턴스로 확장될 수도 있어. 특정 서버 인스턴스의 메모리에만 저장된 데이터는 다른 인스턴스에서는 접근할 수 없고, 재시작하면 날아가 버려. "분명 저장했는데 어디 갔지? 귀신이 곡할 노릇."
3.  **확장성 저해:** 사용자가 늘어서 서버를 여러 대로 늘려야 할 때, 이런 공유 상태는 골칫덩어리가 돼. 각 서버가 자기만의 상태를 가지면 사용자 경험이 오락가락하게 되거든. "이쪽 서버 앨리스랑 저쪽 서버 앨리스는 다른 사람인가요?"

**언제 이런 문제가 생기냐? (언제 조심해야 하냐?)**
SvelteKit의 `+page.server.ts`나 `+server.ts` 파일처럼 서버에서 실행되는 코드에서, 함수 바깥에 `let`이나 `const`로 변수를 선언하고 여러 요청에 걸쳐 그 값을 변경하거나 공유하려고 할 때 발생해. 특히 사용자 인증 정보, 장바구니 내용, 사용자가 입력한 폼 데이터 등을 이런 식으로 다루면 바로 사고 터지는 거야.

**쓸 때 꿀팁 및 주의사항 (어떻게 해결해야 하냐?):**
*   **상태는 클라이언트나 DB에:** 사용자 관련 상태는 브라우저의 `localStorage`, `sessionStorage`, 쿠키에 저장하거나, 서버에서는 각 요청마다 독립적으로 처리하고 필요하면 데이터베이스에 저장/조회해야 해. "개인 물품은 개인 가방에, 공용 물품은 창고에."
*   **요청(Request) 객체 활용:** SvelteKit의 `load` 함수나 `actions` 함수는 `event` 객체 (또는 `request`, `cookies` 등)를 매개변수로 받아. 여기에 사용자별 정보(주로 쿠키를 통해 얻는 세션 정보)를 담아서 처리해야 해. 각 함수 호출은 독립적인 실행 컨텍스트를 가진다고 생각해.
*   **DB를 써라, 제발:** 사용자 데이터처럼 영속성이 필요하고 여러 사용자가 접근해야 하는 정보는 무조건 데이터베이스(PostgreSQL, MySQL, MongoDB 등)를 사용해야 해. "메모리는 휘발유, DB는 안전 금고."
*   **전역 변수는 설정값이나 상수만:** 정말 모든 사용자와 모든 요청에 걸쳐 동일하게 사용되는 설정값(API 키 - 이것도 환경변수가 더 낫지만), 변하지 않는 상수 등은 모듈 레벨에 둘 수 있지만, 이것도 신중해야 해. 사용자별 데이터는 절대 안 돼.
*   **"Stateless" 원칙을 기억해:** 서버는 각 요청을 독립적으로, 이전 요청의 기억 없이 처리하는 것을 이상적으로 생각해. 물론 현실은 캐싱 등으로 성능 최적화를 하지만, 사용자 데이터만큼은 이 원칙을 지켜야 해.

이건 진짜 아무리 강조해도 지나치지 않은 내용이야. 서버에서 공유 상태 잘못 썼다가 서비스 터지는 거 한두 번 본 게 아니거든. "공유지의 비극, 코딩 버전"이라고 생각하면 돼.