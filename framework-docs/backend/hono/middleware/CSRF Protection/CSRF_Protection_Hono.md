# CSRF_Protection_Hono

CSRF(Cross-Site Request Forgery) 공격은 요청 헤더를 체크해서 막는 미들웨어다. 이 녀석은 `Origin` 헤더 값이랑 요청된 URL을 비교해서 폼(form) 요소 같은 걸로 요청을 날리는 CSRF 공격을 막아준다.

근데 `Origin` 헤더를 안 보내는 구닥다리 브라우저나, 리버스 프록시 같은 환경에서 `Origin` 헤더를 홀라당 까먹고 지워버리면 제대로 안 돌아갈 수 있다. 이런 환경에서는 다른 CSRF 토큰 방식을 써야 한다. "만능은 없다는 게 학계의 정설."

**가져오기 (Import)**

```typescript
import { Hono } from 'hono'
import { csrf } from 'hono/csrf'
```

**사용법 (Usage)**

```typescript
const app = new Hono()

// 기본빵
app.use(csrf())

// origin 옵션으로 특정 출처만 허용하기
// 문자열 하나
app.use(csrf({ origin: 'myapp.example.com' }))

// 문자열 배열
app.use(
  csrf({
    origin: ['myapp.example.com', 'development.myapp.example.com'],
  })
)

// 함수로 커스텀 로직 (정규식 등)
// 프로토콜(https://)을 확인하고, 출처 문자열이 정확히 일치하는지 ($를 사용해 끝까지) 검증하는 걸 강력히 권장한다.
// 절대 앞부분만 일치하는 걸로는 안 된다. (예: 'myapp.example.com'으로 시작한다고 다 허용하면 'myapp.example.com.malicious.site'도 통과될 수 있으니 주의)
app.use(
  '*',
  csrf({
    origin: (origin) =>
      /https:\/\/(\w+\.)?myapp\.example\.com$/.test(origin),
  })
)
```

**옵션 (Options)**
*   `origin` (선택 사항): `string | string[] | Function`
    허용할 출처(origin)들을 지정한다.

---

**얘 뭐 하는 애냐?**
CSRF(사이트 간 요청 위조) 공격을 막아주는 방패 같은 놈이다. 웹사이트에 요청이 들어올 때 "너 진짜 우리 식구 맞냐?" 하고 `Origin` 헤더를 검사해서 신원 확인하는 문지기 역할. "아무나 들여보내 줄 순 없지."

**왜 쓰는데? (왜 이런 기능이 필요하고, 왜 알려주는데?)**
1.  **계정 보호**: 악의적인 놈들이 사용자 몰래 비밀번호 변경, 글 삭제 같은 위험한 요청을 못 보내게 막으려고. "내 정보는 내가 지킨다!"
2.  **출처 검증**: 요청 보낸 놈의 `Origin` 헤더를 보고, 미리 허락된 착한 놈인지 아닌지 가려낸다. 아니면 "넌 누구냐?" 시전하고 차단.

**언제 불려 나오냐? (언제 이 기능이 동작하냐?)**
사용자 브라우저가 웹사이트에 뭔가 데이터를 바꾸는 요청(POST, PUT, DELETE 등)을 보낼 때마다 이 미들웨어가 출동해서 검문한다. GET 요청은 보통 데이터 변경이 없어서 덜 빡세게 보지만, 설정하기 나름.

**쓸 때 꿀팁 및 주의사항:**
*   **Origin 검증은 FM대로**: `origin` 옵션, 특히 함수로 정규식 쓸 땐 `https://` 프로토콜이랑 도메인 끝까지(`$`) 확실하게 체크해야 한다. 대충 `startsWith` 같은 걸로 시작 부분만 보면 `evil-myapp.example.com` 같은 짝퉁한테 뒷문 열어주는 꼴. "어설픈 보안은 해킹 프리패스."
*   **구형 브라우저/프록시 환경**: `Origin` 헤더를 안 보내거나 중간에 날아가는 환경에선 이 방식 안 먹힌다. 그럴 땐 고전적인 CSRF 토큰 방식(폼에 숨겨진 값 심어서 검증)을 써야 한다. "최신 기술도 환경빨 탄다."
*   **허용 출처는 깐깐하게**: `origin` 옵션에 별표(`*`) 박아서 "아무나 드루와" 하는 건 개발할 때나 잠깐 쓰고, 실제 서비스에선 절대 금지. 정확한 도메인 목록만 지정해야 안전빵. "우리 집 대문 비번 1234로 하는 소리."
*   **테스트는 실전처럼**: 설정 바꿨으면 다른 도메인에서 진짜로 요청 보내보면서 CSRF 방어가 제대로 작동하는지 꼭 확인해라. "믿는 설정에 발등 찍힌다."