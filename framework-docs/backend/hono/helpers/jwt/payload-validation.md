페이로드 검증 (JWT 토큰 깔 때)

JWT 토큰의 유효성을 확인할 때, 다음 페이로드 항목들을 까봅니다:

*   **`exp` (Expiration Time)**: 토큰 만료 시간. 이 시간이 지났으면 "아, 이거 유통기한 지났네. 못 써!" 하고 퇴짜 놓습니다.
*   **`nbf` (Not Before)**: 토큰 사용 시작 시간. 이 시간 이전에는 "아직 개시 안 했어요, 손님. 나중에 다시 오세요!" 하고 사용을 막습니다.
*   **`iat` (Issued At)**: 토큰 발급 시간. 혹시나 이 시간이 현재보다 미래로 찍혀있으면 "시간 여행이라도 하셨나? 이 토큰은 아직 태어나지도 않았어!" 하고 오류를 냅니다. (시계 안 맞는 서버에서 발급된 경우 등)

만약 이런 검증들을 하고 싶다면, JWT 페이로드 만들 때 이 필드들을 객체 형태로 꼭 포함시켜야 합니다. 안 그러면 "뭘 보고 검증하라는 거야?" 하면서 그냥 통과시켜 버릴 수도 있습니다.

---

**얘 뭐 하는 애냐?**
JWT(JSON Web Token)라는 게 "나 이런 권한 있는 사람이야!" 하고 보여주는 디지털 신분증 같은 건데, 이 신분증이 진짜인지, 위조된 건 아닌지, 유효기간은 남았는지 등을 확인하는 과정에서 '페이로드(payload)'라고 불리는 내용물을 꼼꼼히 살펴보는 작업을 말합니다. 특히 `exp`, `nbf`, `iat` 이 세 가지 시간 관련 정보는 "시간아, 멈춰라!"가 안 통하는 디지털 세계에서 아주 중요한 검증 포인트입니다.

**왜 쓰는데?**
1.  **보안 강화 (만료된 토큰 거부)**: `exp` 체크는 기본 중의 기본. 만약 해커가 탈취한 토큰이 영원히 유효하다면? 끔찍하죠. 만료 시간을 정해두면 설령 토큰이 새나가도 피해를 특정 시간으로 한정할 수 있습니다. "신용카드 유효기간 같은 거."
2.  **토큰 오남용 방지 (미래 사용/과거 사용 방지)**:
    *   `nbf`: 특정 이벤트(예: 프로모션 시작) 이후에만 토큰이 유효하게 만들고 싶을 때 씁니다. "쿠폰은 내일부터 사용 가능합니다!"
    *   `iat`: 토큰이 발급된 시간을 기록해서, 혹시 시스템 시간 오류로 미래에 발급된 것처럼 보이는 비정상적인 토큰을 걸러낼 수 있습니다. 또한, 토큰이 발급된 지 너무 오래되었다면 (예: 1년 전 발급된 세션 토큰) 의심해 볼 근거가 되기도 합니다.
3.  **시스템 안정성 확보**: 시간 검증은 토큰 기반 인증 시스템의 기본적인 방어선입니다. 이게 제대로 안 되면 인증 시스템 전체가 흔들릴 수 있습니다.

**언제 불려 나오냐?**
클라이언트가 API 요청 같은 걸 할 때 HTTP 헤더에 JWT를 딱 붙여서 보냅니다. 그럼 서버 쪽 미들웨어나 인증 로직에서 `jwt.verify()` 같은 함수를 호출해서 토큰을 검증하는데, 바로 이때! `exp`, `nbf`, `iat` 값들이 현재 시간이랑 비교되면서 체크리스트에 도장이 찍히거나 X표시가 그어집니다.

**쓸 때 꿀팁 및 주의사항:**
*   **시간 동기화는 생명**: 서버랑 클라이언트, 그리고 토큰 발급 서버까지 시간 설정이 제각각이면 `exp`, `nbf`, `iat` 검증이 엉망진창이 될 수 있습니다. "내 시계는 5분 빠른데, 네 시계는 3분 느리네? 그럼 토큰은 언제 만료된 거냐?" NTP(Network Time Protocol) 같은 걸로 서버 시간을 정확하게 동기화하는 게 필수입니다.
*   **`leeway` (허용 오차 시간) 옵션 활용**: 네트워크 지연이나 약간의 시간 불일치 때문에 정상적인 토큰이 거부될 수도 있습니다. 그래서 JWT 검증 라이브러리들은 보통 `leeway` 옵션을 제공해서 몇 초 정도의 시간 오차는 눈감아줍니다. "1~2초 늦었다고 바로 칼같이 자르진 말자." 하지만 너무 길게 주면 보안 구멍이 될 수 있으니 적당히!
*   **`exp`는 필수, `nbf`와 `iat`는 상황 따라**: `exp`는 거의 모든 JWT에 들어가는 필수템이지만, `nbf`는 "특정 시간 이후 사용"이라는 명확한 요구사항이 있을 때만 씁니다. `iat`는 발급 시간을 기록하는 용도라 대부분 넣지만, 검증 로직에서 `iat`를 엄격하게 체크할지는 정책에 따라 다릅니다.
*   **페이로드에 뭐가 들었는지부터 확인**: JWT는 `base64url` 인코딩된 문자열이라 그냥 보면 외계어 같습니다. jwt.io 같은 사이트에서 디코딩해보면 페이로드에 어떤 클레임(정보 조각)들이 들어있는지, `exp`, `nbf`, `iat` 값이 제대로 설정되어 있는지 눈으로 확인할 수 있습니다. "까보기 전엔 아무도 모른다."
*   **타임존 문제**: `exp`, `nbf`, `iat`는 보통 유닉스 타임스탬프(1970년 1월 1일 00:00:00 UTC로부터 경과한 시간(초))로 저장됩니다. UTC 기준으로 통일하면 타임존 문제로 골치 아플 일이 줄어듭니다. "시간은 UTC로 통일하는 게 국룰."
*   **에러 처리 잘하기**: 토큰 만료(`TokenExpiredError`), 아직 유효하지 않음(`NotBeforeError`) 같은 에러가 발생했을 때 클라이언트에게 적절한 응답(예: 401 Unauthorized, 재로그인 유도 메시지)을 보내줘야 사용자가 "어? 왜 안 되지?" 하고 방황하지 않습니다. "에러 메시지도 친절하게."